<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <script>addEventListener('error', window.__e=function f(e){f.q=f.q||[];f.q.push(e)});</script> <link rel=canonical href=https://kevinjalbert.com/defined_methods-in-rake-tasks-you-re-gonna-have-a-bad-time/> <title>Defined Methods in Rake Tasks; You're Gonna Have a Bad Time | Kevin Jalbert</title> <meta name=description content="Do you define methods within your Rake tasks? You might want to reconsider that, or you're gonna have a bad time down the road. Walkthrough an example which illustrates a tricky gotcha and solution..."/> <meta name=keywords content="ruby, rake, rails"/> <meta name=datePublished content="2016-03-21 00:00:00 UTC"/> <meta property="og:article:published_time" content="2016-03-21 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2016-03-21 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/defined_methods-in-rake-tasks-you-re-gonna-have-a-bad-time/"/> <meta property="og:url" content="https://kevinjalbert.com/defined_methods-in-rake-tasks-you-re-gonna-have-a-bad-time/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="Do you define methods within your Rake tasks? You might want to reconsider that, or you're gonna have a bad time down the road. Walkthrough an example which illustrates a tricky gotcha and solutions to avoiding it."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/kevin-jalbert.jpg"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="Defined Methods in Rake Tasks; You're Gonna Have a Bad Time"/> <meta property="og:description" content="Do you define methods within your Rake tasks? You might want to reconsider that, or you're gonna have a bad time down the road. Walkthrough an example which illustrates a tricky gotcha and solutions to avoiding it."/> <meta property="og:image" content="https://kevinjalbert.com/images/kevin-jalbert.jpg"/> <meta property="og:title" content="Defined Methods in Rake Tasks; You're Gonna Have a Bad Time"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "Defined Methods in Rake Tasks; You're Gonna Have a Bad Time",
       "keywords": "ruby, rake, rails",
       "url": "https://kevinjalbert.com/defined_methods-in-rake-tasks-you-re-gonna-have-a-bad-time/",
       "datePublished": "2016-03-21 00:00:00 UTC",
       "dateModified": "2016-03-21 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/defined_methods-in-rake-tasks-you-re-gonna-have-a-bad-time/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> <script async src="/vendor/analytics/index.js"></script> <script async src="https://www.google-analytics.com/analytics.js"></script> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>Defined Methods in Rake Tasks; You&#39;re Gonna Have a Bad Time</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">March 21, 2016 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>3 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/defined_methods-in-rake-tasks-you-re-gonna-have-a-bad-time/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/ruby/">ruby</a> <a href="/tags/rake/">rake</a> <a href="/tags/rails/">rails</a> </div> </div> </div> <div class=article__separator></div> <p>Rake tasks provide a nice way to handle common tasks surrounding a ruby project. Within Rails projects they are nearly unavoidable and even have their own directory from which they are autoloaded. Eventually a project will grow in size and complexity to warrant multiple <em>task</em> files for better separation of concerns. This alone is nothing to be worried about, but it&rsquo;s when you start using methods in your task files where <em>you&rsquo;re gonna have a bad time</em>.</p> <p>Let&rsquo;s setup a dummy Rails project that has a task file that calculates and saves blog metrics.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/tasks/blog_metrics_task.rake</span>
<span class="n">desc</span> <span class="s1">'Calculate and save blog metrics'</span>
<span class="n">task</span> <span class="ss">:blog_metrics</span> <span class="k">do</span>
  <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_blog_metrics</span>
  <span class="n">save</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">calculate_blog_metrics</span>
  <span class="nb">puts</span> <span class="s2">"Calculating blog metrics"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Saving blog metrics"</span>
<span class="k">end</span>
</code></pre></div> <p>When we run our task it does exactly what we wanted and expected it to do.</p> <div class=highlight><pre class="highlight plaintext"><code>$ rake blog_metrics
Calculating blog metrics
Saving blog Metrics
</code></pre></div> <p>No problem! Now lets fast-forward in time to when we want to add another task that creates a new blog post.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/tasks/create_blog_post_task.rake</span>
<span class="n">desc</span> <span class="s1">'Create and save a new blog post'</span>
<span class="n">task</span> <span class="ss">:create_blog_post</span> <span class="k">do</span>
  <span class="n">blog_post</span> <span class="o">=</span> <span class="n">generate_default_blog_post</span>
  <span class="n">save</span><span class="p">(</span><span class="n">blog_post</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">generate_default_blog_post</span>
  <span class="nb">puts</span> <span class="s2">"Generating a default blog post"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">blog_post</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Saving default blog post"</span>
<span class="k">end</span>
</code></pre></div> <p>When we run our new task it does exactly what we wanted and expected it to do.</p> <div class=highlight><pre class="highlight plaintext"><code>$ rake create_blog_post
Generating a default blog post
Saving default blog post
</code></pre></div> <p>Another success! Now here is where things get interesting. Let&rsquo;s go back and run the first <em>correctly working</em> task.</p> <div class=highlight><pre class="highlight plaintext"><code>$ rake blog_metrics
Calculating blog metrics
Saving default blog post
</code></pre></div> <p>Woah&hellip; it&rsquo;s the <code>#save</code> that was defined in the other task file &ndash; <code>create_blog_post_task.rake</code>.</p> <p>This is kind of shocking and might have caught you off guard. Rails automatically loads all rake tasks (i.e., requires their file) when executing any rake task. The <em>gotcha</em> here is that the defined methods in the loaded tasks files end up defined on the global namespace. These defined methods are therefore accessible across rake files, so it is <em>possible</em> for methods to clash and be redefined if their signatures match.</p> <p>To better illustrate the order of events:</p> <ol> <li><code>rake blog_metrics</code></li> <li><em>Rails autoloads all rake tasks in alphanumeric order</em></li> <li><code>lib/tasks/blog_metrics_task.rake</code> <em>is loaded and defines</em> <code>#calculate_blog_metrics</code> <em>and</em> <code>#save</code></li> <li><code>lib/tasks/create_blog_post_task.rake</code> <em>is loaded and defines</em> <code># generate_default_blog_post</code> <em>and <strong>redefines</strong></em> <code>#save</code></li> <li><code>blog_metrics</code> <em>task is executed using last defined <code>#save</code>, which was defined in the other task file</em></li> </ol> <p>No worries right? Rake provides a &lsquo;namespace&rsquo; DSL. So we can modify our tasks to use this.</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">namespace</span> <span class="ss">:blog_metrics</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">'Calculate and save blog metrics'</span>
  <span class="n">task</span> <span class="ss">:run</span> <span class="k">do</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_blog_metrics</span>
    <span class="n">save</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_blog_metrics</span>
    <span class="nb">puts</span> <span class="s2">"Calculating blog metrics"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Saving blog metrics"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>We should be in the clear now.</p> <div class=highlight><pre class="highlight plaintext"><code>$ rake blog_metrics:run
Calculating blog metrics
Saving default blog post
</code></pre></div> <p>Nope! The namespace DSL does nothing for the defined methods. So we still have the same problem.</p> <p>There are a couple of solutions to this problem:</p> <ol> <li>Rename the methods, and ensure all future methods are uniquely named</li> <li>Inline the contents of the defined methods</li> <li>Extract the methods into a module/class and use that</li> </ol> <h1>Solution #1 - Uniquely Named Methods</h1> <p>It is possible to simply ensure that we uniquely name our methods so that they do no clash and end up redefining each other.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/tasks/blog_metrics_task.rake</span>
<span class="n">desc</span> <span class="s1">'Calculate and save blog metrics'</span>
<span class="n">task</span> <span class="ss">:blog_metrics</span> <span class="k">do</span>
  <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_blog_metrics</span>
  <span class="n">save</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">calculate_blog_metrics</span>
  <span class="nb">puts</span> <span class="s2">"Calculating blog metrics"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">save_blog_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Saving blog metrics"</span>
<span class="k">end</span>
</code></pre></div><div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/tasks/create_blog_post_task.rake</span>
<span class="n">desc</span> <span class="s1">'Create and save a new blog post'</span>
<span class="n">task</span> <span class="ss">:create_blog_post</span> <span class="k">do</span>
  <span class="n">blog_post</span> <span class="o">=</span> <span class="n">generate_default_blog_post</span>
  <span class="n">save</span><span class="p">(</span><span class="n">blog_post</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">generate_default_blog_post</span>
  <span class="nb">puts</span> <span class="s2">"Generating a default blog post"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">save_default_blog_post</span><span class="p">(</span><span class="n">blog_post</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Saving defualt blog post"</span>
<span class="k">end</span>
</code></pre></div> <p>This works and is a quick fix, although it is not exactly sustainable and requires you to be conscientious when naming new methods.</p> <h1>Solution #2 - Inline Method Contents</h1> <p>To ensure that method redefinition doesn&rsquo;t occur we can simply remove the methods and inline their content.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/tasks/blog_metrics_task.rake</span>
<span class="n">desc</span> <span class="s1">'Calculate and save blog metrics'</span>
<span class="n">task</span> <span class="ss">:blog_metrics</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s2">"Calculating blog metrics"</span>
  <span class="n">metrics</span> <span class="o">=</span> <span class="c1"># Inline calculating work</span>

  <span class="nb">puts</span> <span class="s2">"Saving blog metrics"</span>
  <span class="c1"># Inline saving work</span>
<span class="k">end</span>
</code></pre></div><div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/tasks/create_blog_post_task.rake</span>
<span class="n">desc</span> <span class="s1">'Create and save a new blog post'</span>
<span class="n">task</span> <span class="ss">:create_blog_post</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s2">"Generating a default blog post"</span>
  <span class="n">blog_post</span> <span class="o">=</span> <span class="c1"># Inline blog post generation work</span>

  <span class="nb">puts</span> <span class="s2">"Saving default blog post"</span>
  <span class="c1"># Inline saving work</span>
<span class="k">end</span>
</code></pre></div> <p>This is also a quick fix, and might be optimal depending on the size, complexity, and reuse of the method&rsquo;s content.</p> <h1>Solution #3 - Extract Methods into Module/Class</h1> <p>Removing the methods from the rake files themselves is another valid solution. The methods can be extracted into their own class or module and used within the task files.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/blog_metric_calculator.rb</span>
<span class="k">class</span> <span class="nc">BlogMetricCalculator</span>
  <span class="k">def</span> <span class="nf">metrics</span>
    <span class="nb">puts</span> <span class="s2">"Calculating blog metrics"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Saving blog metrics"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># lib/tasks/blog_metrics_task.rake</span>
<span class="nb">require</span> <span class="s1">'lib/blog_metric_calculator'</span>

<span class="n">desc</span> <span class="s1">'Calculate and save blog metrics'</span>
<span class="n">task</span> <span class="ss">:blog_metrics</span> <span class="k">do</span>
  <span class="n">calculator</span> <span class="o">=</span> <span class="no">BlogMetricCalculator</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">calculator</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">calculator</span><span class="p">.</span><span class="nf">metrics</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div><div class=highlight><pre class="highlight ruby"><code><span class="c1"># lib/blog_post_creator.rb</span>
<span class="k">module</span> <span class="nn">BlogPostCreator</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_default_blog_post</span>
    <span class="nb">puts</span> <span class="s2">"Generating a default blog post"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Saving default blog post"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># lib/tasks/create_blog_post_task.rake</span>
<span class="nb">require</span> <span class="s1">'lib/blog_post_creator'</span>

<span class="n">desc</span> <span class="s1">'Create and save a new blog post'</span>
<span class="n">task</span> <span class="ss">:create_blog_post</span> <span class="k">do</span>
  <span class="n">blog_post</span> <span class="o">=</span> <span class="no">BlogPostCreator</span><span class="p">.</span><span class="nf">create_default_blog_post</span>
  <span class="no">BlogPostCreator</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">blog_post</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div> <p>This is the preferred method if there is sufficient complexity involved. By extracting the methods you begin to build up a set of related concerns within a module/class. By having an external entity outside of the rake tasks themselves you can now <em>test</em> the defined functionality!</p> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> Signup for my Newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="email address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="col-md-12 footer__copywrite"> &copy; 2018 Kevin Jalbert </div> </html> <script src="/javascripts/app.js"></script>