<!DOCTYPE html> <html lang=en> <head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SZ2C67981H"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SZ2C67981H');
    </script> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=canonical href=https://kevinjalbert.com/graphql-persisted-queries-with-http-caching-part-2/> <title>GraphQL Persisted Queries with HTTP Caching [Part 2] | Kevin Jalbert</title> <meta name=description content="This is the second of four parts on GraphQL Persisted Queries with HTTP Caching. We'll setup a React application and Express server, both using GraphQL. We will refactor these applications to suppo..."/> <meta name=keywords content="graphql, rails, express, http caching"/> <meta name=datePublished content="2018-07-16 00:00:00 UTC"/> <meta property="og:article:published_time" content="2018-07-16 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2018-07-16 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/graphql-persisted-queries-with-http-caching-part-2/"/> <meta property="og:url" content="https://kevinjalbert.com/graphql-persisted-queries-with-http-caching-part-2/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="This is the second of four parts on GraphQL Persisted Queries with HTTP Caching. We'll setup a React application and Express server, both using GraphQL. We will refactor these applications to support persisted queries."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/2018-07-16-graphql-persisted-queries-with-http-caching-part-2/post-query.png"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="GraphQL Persisted Queries with HTTP Caching [Part 2]"/> <meta property="og:description" content="This is the second of four parts on GraphQL Persisted Queries with HTTP Caching. We'll setup a React application and Express server, both using GraphQL. We will refactor these applications to support persisted queries."/> <meta property="og:image" content="https://kevinjalbert.com/images/2018-07-16-graphql-persisted-queries-with-http-caching-part-2/post-query.png"/> <meta property="og:title" content="GraphQL Persisted Queries with HTTP Caching [Part 2]"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "GraphQL Persisted Queries with HTTP Caching [Part 2]",
       "keywords": "graphql, rails, express, http caching",
       "url": "https://kevinjalbert.com/graphql-persisted-queries-with-http-caching-part-2/",
       "datePublished": "2018-07-16 00:00:00 UTC",
       "dateModified": "2018-07-16 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/graphql-persisted-queries-with-http-caching-part-2/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="/uses/">Uses</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>GraphQL Persisted Queries with HTTP Caching [Part 2]</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">July 16, 2018 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>7 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/graphql-persisted-queries-with-http-caching-part-2/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/express/">express</a> <a href="/tags/graphql/">graphql</a> <a href="/tags/http-caching/">http caching</a> <a href="/tags/rails/">rails</a> </div> </div> </div> <img src=/images/2018-07-16-graphql-persisted-queries-with-http-caching-part-2/post-query.png> <i><p>Generated with <a href="https://carbon.now.sh/">Carbon.now.sh</a></p> </i> <div class=article__separator></div> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> If you enjoy this, consider subscribing to my newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <p style="text-align: center">I aim to publish one article a month</p> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="E-mail address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <p>This is the second part of a four part series on GraphQL Persisted Queries with HTTP Caching. As a recap of <a href="/graphql-persisted-queries-with-http-caching-part-1/">part one</a>, we described some issues with GraphQL and how persisted queries can be a solution for them. We also covered what persisted queries were from a high-level.</p> <p>In part two we will cover the following topics:</p> <ol> <li>Setup Express Server</li> <li>Setup React Application</li> <li>Refactor React Application to use Persisted Queries</li> <li>Extract GraphQL Queries from Client</li> <li>Refactor Express Server to use Persisted Queries</li> </ol> <h1>Setup Express Server</h1> <blockquote> <p>Follow along with the complete code changes on <a href="https://github.com/kevinjalbert/graphql-persisted-queries/commit/5ac1a2a8dcc1757d145503ca0d209bcccca0ed97">GitHub</a></p> </blockquote> <p>To begin, we&rsquo;re going to setup up a very simple Express server that&rsquo;ll serve up a GraphQL API. Let&rsquo;s break down the following file:</p> <div class=highlight><pre class="highlight javascript"><code><span class="c1">// server.js</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">GraphQLServer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">graphql-yoga</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">typeDefs</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./graphql/typeDefs</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">resolvers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./graphql/resolvers</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GraphQLServer</span><span class="p">({</span> <span class="nx">typeDefs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">})</span>
<span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="na">endpoint</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/graphql</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">playground</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/playground</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">({</span> <span class="nx">port</span> <span class="p">})</span> <span class="o">=&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="s2">`Server started, listening on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2"> for incoming requests.`</span><span class="p">,</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div> <p>We have our GraphQL types and resolvers defined under the <code>./graphql</code> directory. The resolvers are pulling data from <code>data.json</code>, which is just an easier way to get this API started. In our example, we&rsquo;re serving up data on video game consoles, so the data doesn&rsquo;t change that often.</p> <p>Using <code>graphql-yoga</code> we can create a <code>GraphQLServer</code>, supply it with the type definitions and resolvers. We set a couple of <em>options</em> then we start the server.</p> <h1>Setup React Application</h1> <blockquote> <p>Follow along with the complete code changes on <a href="https://github.com/kevinjalbert/graphql-persisted-queries/commit/c992730643a39f72bd5f5b6e335eb103b3646949">GitHub</a></p> </blockquote> <p>To take advantage of our Express Server that is exposing a GraphQL API, we&rsquo;re going to create a simple React application to use it. We&rsquo;ll use <code>create-react-app</code> for our foundation, and add in <code>react-apollo</code> and <code>apollo-boost</code> to bootstrap the GraphQL.</p> <p><strong>Note:</strong> we need to use the <a href="https://github.com/facebook/create-react-app/pull/3909"><em>next</em> version (2.x) of <code>react-scripts</code> so that we can take advantage of a <code>graphql-tag/loader</code></a> to load up <a href="https://dev-blog.apollodata.com/5-benefits-of-static-graphql-queries-b7fa90b0b69a">static <code>.graphql</code> files</a>.</p> <p>We&rsquo;ll first initialize our Apollo client and render our <code>App</code> to the DOM. In addition, we need to set up the Apollo Client and point it to our GraphQL API. The following <code>index.js</code> file accomplishes all this setup:</p> <div class=highlight><pre class="highlight jsx"><code><span class="c1">// index.js</span>
<span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-dom</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">registerServiceWorker</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./registerServiceWorker</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">ApolloClient</span><span class="p">,</span> <span class="nx">InMemoryCache</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">apollo-boost</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ApolloProvider</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-apollo</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createHttpLink</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">apollo-link-http</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./components/App</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">./index.css</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApolloClient</span><span class="p">({</span>
  <span class="na">link</span><span class="p">:</span> <span class="nx">createHttpLink</span><span class="p">({</span> <span class="na">uri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:5000/graphql</span><span class="dl">'</span> <span class="p">}),</span>
  <span class="na">cache</span><span class="p">:</span> <span class="k">new</span> <span class="nx">InMemoryCache</span><span class="p">(),</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">AppWithProvider</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">ApolloProvider</span> <span class="na">client=</span><span class="si">{</span><span class="nx">client</span><span class="si">}</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">App</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nc">ApolloProvider</span><span class="p">&gt;</span>
<span class="p">);</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nc">AppWithProvider</span> <span class="p">/&gt;,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">registerServiceWorker</span><span class="p">();</span>
</code></pre></div> <p>Nothing special is happening in our <code>App</code> component, as we&rsquo;re just creating some input controls and passing the data to our <code>ConsoleContainer</code> component. All our GraphQL data loading and usage is handled within the <code>ConsoleContainer</code>:</p> <div class=highlight><pre class="highlight jsx"><code><span class="c1">// components/ConsoleContainer.js</span>
<span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">PropTypes</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">prop-types</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Query</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-apollo</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">QUERY</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../graphql/ConsolesByYear.graphql</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">ConsolesAndCompany</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">afterYear</span><span class="p">,</span> <span class="nx">beforeYear</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Query</span> <span class="na">query=</span><span class="si">{</span><span class="nx">QUERY</span><span class="si">}</span> <span class="na">variables=</span><span class="si">{</span><span class="p">{</span> <span class="nx">afterYear</span><span class="p">,</span> <span class="nx">beforeYear</span> <span class="p">}</span><span class="si">}</span> <span class="na">fetchPolicy=</span><span class="s1">'network-only'</span><span class="p">&gt;</span>
    <span class="si">{</span><span class="p">({</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">loading</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span> <span class="dl">'</span><span class="s1">Error!</span><span class="dl">'</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">loading</span><span class="p">)</span> <span class="k">return</span> <span class="dl">'</span><span class="s1">Loading</span><span class="dl">'</span><span class="p">;</span>

      <span class="k">return</span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">React</span><span class="p">.</span><span class="nc">Fragment</span><span class="p">&gt;</span>
          <span class="si">{</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">consoles</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">console</span> <span class="o">=&gt;</span> <span class="p">(</span>
              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">key=</span><span class="si">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>Release Year: <span class="si">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">releaseYear</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>Company: <span class="si">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">company</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">))</span>
          <span class="si">}</span>
        <span class="p">&lt;/</span><span class="nc">React</span><span class="p">.</span><span class="nc">Fragment</span><span class="p">&gt;</span>
      <span class="p">);</span>
    <span class="p">}</span><span class="si">}</span>
  <span class="p">&lt;/</span><span class="nc">Query</span><span class="p">&gt;</span>
<span class="p">);</span>

<span class="nx">ConsolesAndCompany</span><span class="p">.</span><span class="nx">propTypes</span> <span class="o">=</span> <span class="p">{</span> <span class="na">afterYear</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">number</span><span class="p">,</span> <span class="na">beforeYear</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">number</span> <span class="p">};</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">ConsolesAndCompany</span><span class="p">;</span>
</code></pre></div> <p>Notice that we&rsquo;re loading the <code>QUERY</code> from a static file. The <code>Query</code> component then allows the Apollo client to handle the networking, storage, and retrieval of the query. Our component finally renders new <code>React.Fragments</code> to the DOM with the resolved data.</p> <h1>Refactor React Application to use Persisted Queries</h1> <blockquote> <p>Follow along with the complete code changes on <a href="https://github.com/kevinjalbert/graphql-persisted-queries/commit/f8b91be248c3b5c41813fc01dd99f05e3f62bf69">GitHub</a></p> </blockquote> <p>In the last two sections we created a simple React application using Apollo client that uses a GraphQL API being served on Express. With a small change on our React application we can make it <em>persisted query</em> enabled.</p> <p>We take advantage of the <a href="https://github.com/apollographql/apollo-link-persisted-queries"><code>apollo-link-persisted-queries</code></a> (an <em>Apollo Link</em>) to modify the Apollo client. While it isn&rsquo;t <em>too difficult</em> to roll our own implementation, it is best to lean on community supported projects. Using this package will help us narrow down what our future implementation needs to conform to on the server-side. In addition, it provides some <em>portability/compatibility</em> with different projects due to being a community solution.</p> <div class=highlight><pre class="highlight javascript"><code><span class="c1">// index.js</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createPersistedQueryLink</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">apollo-link-persisted-queries</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// ... rest of file</span>

<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApolloClient</span><span class="p">({</span>
  <span class="na">link</span><span class="p">:</span> <span class="nx">createPersistedQueryLink</span><span class="p">().</span><span class="nx">concat</span><span class="p">(</span>
    <span class="nx">createHttpLink</span><span class="p">({</span> <span class="na">uri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:5000/graphql</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">),</span>
  <span class="na">cache</span><span class="p">:</span> <span class="k">new</span> <span class="nx">InMemoryCache</span><span class="p">(),</span>
<span class="p">});</span>

<span class="c1">// ... rest of file</span>
</code></pre></div> <p>At this point our React application will be sending outbound <code>POST</code> requests with the following body:</p> <div class=highlight><pre class="highlight plaintext"><code>{
  extensions: {
    persistedQuery: {
      version: 1,
      sha256Hash: "a38e6d5349901b395334b5fd3b14e84a7ca7c4fc060a4089f2c23b5cf76f0f80"
    }
  },
  operationName: "ConsolesByYear",
  variables: {
    afterYear: 1990,
    beforeYear: 1999
  }
}
</code></pre></div> <p>We have our <code>operationName</code>, <code>variables</code> and the <code>extensions</code> properties present. Within the <code>extensions</code> property, we really only care about the <code>persistedQuery.sha256Hash</code> value. The <code>sha256Hash</code> value is automatically computed on-the-fly based on the outgoing query (it is worth noting you can <a href="https://github.com/apollographql/apollo-link-persisted-queries#build-time-generation">calculate the hashes at build-time</a>). Thus, we now need a way to identify the queries by this signature on the server.</p> <h1>Extract GraphQL Queries from React Application</h1> <blockquote> <p>Follow along with the complete code changes on <a href="https://github.com/kevinjalbert/graphql-persisted-queries/commit/078b3d2784add9b54b831b7e0b662ebea2bd9d4e">GitHub</a></p> </blockquote> <p>We can use the <a href="https://github.com/apollographql/persistgraphql">persistgraphql</a> tool from Apollo to help extract queries from the client application. This tool recursively scans a directory and looks for GraphQL queries (i.e., <code>.graphql</code> files), then it generates a JSON file of <code>query_string</code> keys mapped to <code>id</code> values. Unfortunately, this tool&rsquo;s major flaw is that the <code>id</code> ends up being an auto-incremented number:</p> <div class=highlight><pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"&lt;query_string_1&gt;"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"&lt;query_string_2&gt;"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"&lt;query_string_3&gt;"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div> <p>Auto-incrementing ids aren&rsquo;t going to uniquely identify the query string, thus causing long-term concerns when you need to extract the queries multiple times or from multiple clients. Ideally, you could use some cryptographic hash function to come up with the unique ids, which effectively becomes the query&rsquo;s signature). Currently, there are GitHub issues discussing these concerns (<a href="https://github.com/apollographql/persistgraphql/pull/35">pull request #35</a> and <a href="https://github.com/apollographql/persistgraphql/issues/34">issue #34</a>).</p> <p>There are general questions and concerns with the tool&rsquo;s operation and how to use the output:</p> <ul> <li>How do you sync them to the server (<a href="https://github.com/apollographql/persistgraphql/issues/52">issue #52</a>)?</li> <li>How do you use them in the client (<a href="https://github.com/apollographql/persistgraphql/issues/42">issue #42</a>)?</li> <li>How can you retain previous queries for a build process (<a href="https://github.com/apollographql/persistgraphql/issues/17">issue #17</a>)?</li> </ul> <p>Apollo has another tool, <a href="https://github.com/apollographql/apollo-codegen">apollo-codegen</a>, that handles extracting queries for the purpose of generating code for other languages and types (i.e., Swift, Scala, Flow, etc&hellip;). It has been brought up in <a href="https://github.com/apollographql/apollo-codegen/issues/314">issue #314</a> that a unification of <code>persistgraphql</code> and <code>apollo-codegen</code> would be ideal. In an article titled <a href="https://leoasis.github.io/posts/2018/04/27/graphql-persisted-documents/">GraphQL Persisted Documents</a> (by <a href="https://twitter.com/leogcrespo">Leonardo Garcia Crespo</a>), the landscape for extracting and using persisted queries can be confusing.</p> <p>For the purpose of what we want to do, we will reuse the existing logic that <code>persistgraphql</code> has to extract the queries and add in a post-process that will determine a unique signature for each query to match what we need. I created a script, <a href="https://github.com/kevinjalbert/graphql-persisted-queries/tree/master/persistgraphql-signature-sync"><code>persistgraphql-signature-sync</code></a>, to extract the queries from the client and augmented the <code>id</code>s to be a hash of the query acting as the unique signature. A SHA 256 hashing algorithm is used so that the generated hash value is the same as the ones generated by <code>apollo-link-persisted-queries</code>. It also handles synchronization of queries to an endpoint, which we will explore in a later section.</p> <p>The following command:</p> <div class=highlight><pre class="highlight plaintext"><code>node index.js --input-path=../react-graphql/src --output-file=./extracted_queries.json
</code></pre></div> <p>produces a JSON file holding the query strings and their signatures:</p> <div class=highlight><pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query ConsolesByYear($afterYear: Int, $beforeYear: Int) {\n  consoles(afterYear: $afterYear, beforeYear: $beforeYear) {\n    ...ConsoleFieldsFragment\n    company {\n      name\n      __typename\n    }\n    __typename\n  }\n}\n\nfragment ConsoleFieldsFragment on Console {\n  name\n  releaseYear\n  __typename\n}\n"</span><span class="p">:</span><span class="s2">"a38e6d5349901b395334b5fd3b14e84a7ca7c4fc060a4089f2c23b5cf76f0f80"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div> <h1>Refactor Express Server to use Persisted Queries</h1> <blockquote> <p>Follow along with the complete code changes on <a href="https://github.com/kevinjalbert/graphql-persisted-queries/commit/a386f13fdc4e97ff0ceb4f159038eb924ced8386">GitHub</a></p> </blockquote> <p>We now have our <code>extracted_queries.json</code> file containing our mapping of queries to signatures. We can go back and refactor our express server to use the output file containing the mapping to support persisted queries.</p> <div class=highlight><pre class="highlight javascript"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">GraphQLServer</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">graphql-yoga</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="p">{</span> <span class="nx">typeDefs</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./graphql/typeDefs</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">resolvers</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./graphql/resolvers</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">persistedQueriesMiddleware</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./persistedQueriesMiddleware</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GraphQLServer</span><span class="p">({</span> <span class="nx">typeDefs</span><span class="p">,</span> <span class="nx">resolvers</span> <span class="p">})</span>
<span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="na">endpoint</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/graphql</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">playground</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/playground</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/graphql</span><span class="dl">'</span><span class="p">,</span> <span class="nx">persistedQueriesMiddleware</span><span class="p">)</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">({</span> <span class="nx">port</span> <span class="p">})</span> <span class="o">=&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="s2">`Server started, listening on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2"> for incoming requests.`</span><span class="p">,</span>
  <span class="p">),</span>
<span class="p">)</span>
</code></pre></div> <p>We have added two things here:</p> <ol> <li>We use the <code>bodyParser</code> middleware that will allow us to access the <code>body</code> parameters on <code>POST</code> requests.</li> <li>We have a new <code>persistedQueriesMiddleware</code> that attaches onto the <code>/graphql</code> <code>POST</code> route.</li> </ol> <p>We add the first middleware so that we can access the <code>req.body</code> in our custom <code>persistedQueriesMiddleware</code> middleware.</p> <div class=highlight><pre class="highlight javascript"><code><span class="c1">// persistedQueriesMiddleware.js</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">invert</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">lodash</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">extractedQueries</span> <span class="o">=</span> <span class="nx">invert</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./extracted_queries.json</span><span class="dl">'</span><span class="p">))</span>

<span class="nx">persistedQueriesMiddleware</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Handling request to: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">querySignature</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">extensions</span><span class="p">.</span><span class="nx">persistedQuery</span><span class="p">.</span><span class="nx">sha256Hash</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">persistedQuery</span> <span class="o">=</span> <span class="nx">extractedQueries</span><span class="p">[</span><span class="nx">querySignature</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">persistedQuery</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">errors</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">Invalid querySignature</span><span class="dl">'</span><span class="p">]</span> <span class="p">})</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid querySignature</span><span class="dl">'</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">persistedQuery</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">persistedQueriesMiddleware</span> <span class="p">}</span>
</code></pre></div> <p>Recall the persisted query request body from our React application. We need to pull out the <code>sha256Hash</code> value as our signature and do a lookup in our <code>extracted_queries.json</code> file for the matching query. If we find a match, then we can set the <em>query</em> to the actual query string and pass the request through to the underlying server to be resolved.</p> <h1>Reflection</h1> <p>At this point we&rsquo;ve built:</p> <ul> <li>An Express server that exposes a GraphQL API.</li> <li>A React application that uses Apollo to communicate with our GraphQL API.</li> <li>A script to help to with extracting persisted queries from our React application.</li> </ul> <p>Our Express server is using a static file, <code>extracted_queries.json</code>, to do the mapping of the query to the signature. While this approach gets the job done, you might want to take it to the next level where this information is stored in a database (or similar storage). This adaptation comes with the following:</p> <ul> <li>If we&rsquo;re using a database, it becomes possible to create more analytics and administration around persisted queries.</li> <li>If you have multiple clients, they would all produce their own JSON file of persisted queries. You will then have to track/manage/merge these and possible commit them to your server code.</li> <li>Each time you update your persisted queries you will require a restart or redeployment of the server. With a database synchronization approach, you can send the queries to be persisted while the server is running.</li> </ul> <p>We will take a look at the next iteration of our persisted queries implementation, one that&rsquo;ll use synchronization &ndash; using a Rails server backed by a database. We will cover this in the third part of our series.</p> <blockquote> <p>This topic was presented at <a href="https://www.meetup.com/GraphQL-Toronto/events/251760335/">GraphQL Toronto July 2018</a>:</p> <ul> <li><a href="https://www.youtube.com/watch?v=ocX_jf81LwE">Watch the talk</a></li> <li><a href="https://speakerdeck.com/kevinjalbert/graphql-persisted-queries-with-http-caching">Read the slides</a></li> </ul> </blockquote> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="container footer"> <div class="col-md-12 footer__social"> <a href="https://twitter.com/KevinJalbert">Twitter</a> <a href="https://github.com/kevinjalbert">GitHub</a> <a href="https://stackoverflow.com/users/583592/kevin-jalbert">Stack Overflow</a> </div> <div class="col-md-12 footer__copywrite"> Code licensed <a href="https://github.com/kevinjalbert/kevinjalbert.github.io/blob/real-master/LICENSE">MIT</a>, Content &copy; 2019 Kevin Jalbert </div> </div> </html> <script src="/javascripts/app.js"></script>