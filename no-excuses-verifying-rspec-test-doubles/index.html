<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <script>addEventListener('error', window.__e=function f(e){f.q=f.q||[];f.q.push(e)});</script> <link rel=canonical href=https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/> <title>No Excuses: Verifying RSpec Test Doubles | Kevin Jalbert</title> <meta name=description content="RSpec 3.0 introduces new verifying doubles that offer the ability to verify received messages against the underlying class/object. Learn how using verifying doubles offer more robust tests with lit..."/> <meta name=keywords content="ruby, rspec, testing"/> <meta name=datePublished content="2015-04-28 00:00:00 UTC"/> <meta property="og:article:published_time" content="2015-04-28 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2015-04-28 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/"/> <meta property="og:url" content="https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="RSpec 3.0 introduces new verifying doubles that offer the ability to verify received messages against the underlying class/object. Learn how using verifying doubles offer more robust tests with little effort."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/kevin-jalbert.jpg"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="No Excuses: Verifying RSpec Test Doubles"/> <meta property="og:description" content="RSpec 3.0 introduces new verifying doubles that offer the ability to verify received messages against the underlying class/object. Learn how using verifying doubles offer more robust tests with little effort."/> <meta property="og:image" content="https://kevinjalbert.com/images/kevin-jalbert.jpg"/> <meta property="og:title" content="No Excuses: Verifying RSpec Test Doubles"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "No Excuses: Verifying RSpec Test Doubles",
       "keywords": "ruby, rspec, testing",
       "url": "https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/",
       "datePublished": "2015-04-28 00:00:00 UTC",
       "dateModified": "2015-04-28 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> <script async src="/vendor/analytics/index.js"></script> <script async src="https://www.google-analytics.com/analytics.js"></script> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="/uses/">Uses</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>No Excuses: Verifying RSpec Test Doubles</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">April 28, 2015 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>5 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/rspec/">rspec</a> <a href="/tags/ruby/">ruby</a> <a href="/tags/testing/">testing</a> </div> </div> </div> <div class=article__separator></div> <div class=article__notes> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#notesCollapse"> Notes Since Publication </h4> </div> <div id=notesCollapse class="panel-collapse collapse"> <div class=panel-body> <div class=row> <div class="article__notes-type col-xs-6 col-md-6"> ADD </div> <div class="article__notes-date col-xs-6 col-md-6"> January 23, 2016 </div> <div class="article__notes-content col-xs-12 col-md-12"> <p>Mention of RSpec 3.2&#39;s support for dynamic column methods defined by ActiveRecord in the context of <code>instance_double</code>.</p> </div> </div> </div> </div> </div> </div> <p>Tests which utilize external services or interact with the database are typically the culprits of long-running tests. We want to keep our tests quick. It is possible to mock/stub out long running database and/or external services calls. This reduces the time a test suite takes to execute.</p> <h1>Unsheathe the Double</h1> <p>In Ruby, one approach to mocking is by completely replacing the object of interest with a lightweight <a href="http://www.rubydoc.info/gems/rspec-mocks/frames#Test_Doubles">double</a> using <a href="http://rspec.info/">RSpec</a>. Proper usage of a <em>double</em> can prevent tests from interacting with external services, such as a database (i.e., <code>ActiveRecord</code>).</p> <p>With respect to RSpec, a <em>double</em> is created by providing a classname or object, along with a hash of messages and their responses. A <em>double</em> can only respond using the provided responses to their defined messages (technically there are other messages that a <em>double</em> can respond to, but for our purpose we do not have to worry about them).</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">dog</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Woof'</span><span class="p">)</span>
<span class="n">dog</span><span class="p">.</span><span class="nf">talk</span>  <span class="c1">#=&gt; "Woof"</span>
<span class="n">dog</span><span class="p">.</span><span class="nf">walk</span>  <span class="c1">#=&gt; Double "Dog" received unexpected message :walk with (no args)</span>
</code></pre></div> <p>In the above example, a <code>&#39;Dog&#39;</code> <em>double</em> is created that only knows <code>#talk</code>. When it receives an unknown message like <code>#walk</code> an appropriate exception is raised.</p> <h1>Double-Edge Double</h1> <p>A <em>double</em> aims to abstract away from the concrete concepts that they are <em>standing in for</em> (i.e., defined classes/methods/attributes/associations and their implementations). This can simplify tests by only dealing with the immediate concerns in a restricted scope. Using <em>doubles</em> has its perks, but a problem can arise if changes occur to the underlying concrete concepts.</p> <p>Lets examine the following scenario:</p> <blockquote> <p>We have an existing class with multiple defined methods. This class and its methods primarily interact with external services. This class and its methods are used within our test suite, in where we have mocked it out using a <em>double</em>.</p> <p>We decided to modify a method definition on the described class. Our tests continue to pass.</p> </blockquote> <p>Given this scenario we would hope that by modifying the method definition that our existing tests which depend on said method definition to fail. Our tests are using a <em>double</em> in which the method definition it has defined is still valid, even when the actual method definition has been altered.</p> <p>The consequences of not seeing any failing tests can be serious. Even with minor cosmetic changes, that do not alter functionality, it is still a misleading test. Identifying these tests after the fact can be challenging, as they initially appear to be in fine working order.</p> <p>It is important to always remember to check the usage of <em>doubles</em> whose underlying concepts are changed. A gem called <a href="https://github.com/xaviershay/rspec-fire">rspec-fire</a> was created to alleviate this task. This gem would verify that a <em>double</em> is actually mocking an actual method defined on the concrete object. As of <a href="http://rspec.info/blog/2014/05/notable-changes-in-rspec-3">RSpec 3.0</a>, <em>rspec-fire</em> is now obsolete as RSpec has a set of new <a href="https://relishapp.com/rspec/rspec-mocks/v/3-0/docs/verifying-doubles">verifying doubles</a>. With the release of <a href="http://rspec.info/blog/2015/02/rspec-3-2-has-been-released">RSpec 3.2</a>, <code>instance_double</code> now support dynamic column methods defined by ActiveRecord.</p> <h1>Dance of the Double</h1> <p>A simple example best illustrates the downside of using the original RSpec <em>doubles</em>. In this example we also show how to replace the <em>double</em> with the new and improved verifying <em>doubles</em>, along with their benefits.</p> <p>For this example we are not dealing with a database, although the idea is easily extendable. We can imagine that our test is creating actual entries in the database, thus incurring the performance hit.</p> <hr> <p>First we define an <code>Owner</code> that has a <code>Dog</code>. The <code>Dog</code> responds to <code>#talk</code>. In addition we have a corresponding test that uses a <em>double</em> to mock out the <code>Dog</code> which responds to <code>#talk</code>.</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Owner</span>
  <span class="nb">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">talk</span>
    <span class="s1">'Woof'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># 1 example, 0 failures</span>
</code></pre></div> <hr> <p>We decide to change <code>Dog#talk</code> to <code>Dog#bark</code>, but forget to update the test.</p> <div class=highlight><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Owner</span>
  <span class="nb">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">bark</span>
    <span class="s1">'Woof'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># 1 example, 0 failures</span>
</code></pre></div> <p>From our test&rsquo;s perspective everything is still fine, since our <em>double</em> still responds to <code>#talk</code>. Ideally we would want our test here to fail since it is not accurately matching the interface defined by an actual <code>Dog</code> instance.</p> <p>This is a problem. It is possible to completely <em>forget</em> about fixing the test, since it technically passed.</p> <hr> <p>This time we use a verifying <em>double</em> that RSpec provides such as an <code>instance_double</code>. This ensures that the messages the <em>double</em> receives are verified against the interface defined by the concrete object.</p> <div class=highlight><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="k">class</span> <span class="nc">Owner</span>
  <span class="nb">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">bark</span>
    <span class="s1">'Woof'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Failure/Error: let(:dog) { instance_double('Dog', talk: 'Fake Woof') }</span>
<span class="c1">#   Dog does not implement: talk</span>
<span class="c1"># 1 example, 1 failure</span>
</code></pre></div> <p>Now we have a failing test! This is what we expect to happen as our <em>double</em> is attempting to using an unimplemented method. This feedback allows us to take the corrective action on our tests to ensure that they are not forgotten and invalid.</p> <hr> <p>We now decide to change the number of arguments on <code>Dog#bark</code>. Again with the old non-verifying <em>double</em> our test would again simply pass. The verifying <em>doubles</em> also check that the number of arguments match the defined interface&rsquo;s number of arguments.</p> <div class=highlight><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="k">class</span> <span class="nc">Owner</span>
  <span class="nb">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">talk</span><span class="p">(</span><span class="n">loud</span><span class="p">)</span>
    <span class="n">loud</span> <span class="p">?</span> <span class="s1">'Woof'</span> <span class="p">:</span> <span class="s1">'Woof!!'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Failure/Error: let(:dog) { instance_double('Dog', talk: 'Fake Woof') }</span>
<span class="c1">#   Wrong number of arguments. Expected 1, got 0.</span>
<span class="c1"># 1 example, 1 failure</span>
</code></pre></div> <h1>Double Development</h1> <p>If the underlying class is loaded <code>instance_double</code> will do the verifying on the class. In the situation where the class is not loaded than it acts as a normal <em>double</em>.</p> <p>During development an <code>instance_double</code> allows one to develop in isolation if the class you are mocking out does not yet exist. Eventually when the test is more-or-less complete, it is possible to simply <em>load</em> the class and the <code>instance_double</code> will start to verify on the loaded class.</p> <p>In addition, during development you can use <a href="https://github.com/nevir/rubocop-rspec/blob/master/lib/rubocop/cop/rspec/verified_doubles.rb"><code>rubocop-rspec</code></a> to ensure you always verify your <em>doubles</em>.</p> <h1>Concluding Double</h1> <p><strong>TL;DR &ndash; There are no excuses, verify your RSpec test doubles.</strong></p> <p>Verifying your RSpec test <em>doubles</em> can, and will, save you from many headaches down the road. In most cases the change required to use verifying <em>doubles</em> is relatively easy. The benefits are clear, worthwhile and your test suite will thank you.</p> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> Signup for my Newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="email address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="container footer"> <div class="col-md-12 footer__social"> <a href="https://twitter.com/KevinJalbert">Twitter</a> <a href="https://github.com/kevinjalbert">GitHub</a> <a href="https://stackoverflow.com/users/583592/kevin-jalbert">Stack Overflow</a> </div> <div class="col-md-12 footer__copywrite"> Code licensed <a href="https://github.com/kevinjalbert/kevinjalbert.github.io/blog/real-master/LICENSE">MIT</a>, Content &copy; 2019 Kevin Jalbert </div> </div> </html> <script src="/javascripts/app.js"></script> <div id=amzn-assoc-ad-36830a7e-7ad1-4cf6-983b-8b5b373a62c0></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=36830a7e-7ad1-4cf6-983b-8b5b373a62c0"></script>