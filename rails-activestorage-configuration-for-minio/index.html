<!DOCTYPE html> <html lang=en> <head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SZ2C67981H"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SZ2C67981H');
    </script> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=canonical href=https://kevinjalbert.com/rails-activestorage-configuration-for-minio/> <title>Rails ActiveStorage Configuration for Minio | Kevin Jalbert</title> <meta name=description content="Trying to configure Rails ActiveStorage for Minio as your storage provider? The default configuration does not work out of the box, so read on to see what configuration options you are missing."/> <meta name=keywords content="tools, rails, minio"/> <meta name=datePublished content="2018-02-26 00:00:00 UTC"/> <meta property="og:article:published_time" content="2018-02-26 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2018-02-26 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/rails-activestorage-configuration-for-minio/"/> <meta property="og:url" content="https://kevinjalbert.com/rails-activestorage-configuration-for-minio/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="Trying to configure Rails ActiveStorage for Minio as your storage provider? The default configuration does not work out of the box, so read on to see what configuration options you are missing."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/2018-02-26-rails-activestorage-configuration-for-minio/birdy-boxcar.jpg"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="Rails ActiveStorage Configuration for Minio"/> <meta property="og:description" content="Trying to configure Rails ActiveStorage for Minio as your storage provider? The default configuration does not work out of the box, so read on to see what configuration options you are missing."/> <meta property="og:image" content="https://kevinjalbert.com/images/2018-02-26-rails-activestorage-configuration-for-minio/birdy-boxcar.jpg"/> <meta property="og:title" content="Rails ActiveStorage Configuration for Minio"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "Rails ActiveStorage Configuration for Minio",
       "keywords": "tools, rails, minio",
       "url": "https://kevinjalbert.com/rails-activestorage-configuration-for-minio/",
       "datePublished": "2018-02-26 00:00:00 UTC",
       "dateModified": "2018-02-26 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/rails-activestorage-configuration-for-minio/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="/uses/">Uses</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>Rails ActiveStorage Configuration for Minio</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">February 26, 2018 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>2 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/rails-activestorage-configuration-for-minio/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/minio/">minio</a> <a href="/tags/rails/">rails</a> <a href="/tags/tools/">tools</a> </div> </div> </div> <img src=/images/2018-02-26-rails-activestorage-configuration-for-minio/birdy-boxcar.jpg> <i><p><a href="https://flickr.com/photos/agent_ladybug/661200957" title="birdy boxcar">birdy boxcar</a> by <a href="https://flickr.com/people/agent_ladybug">b.ug</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc/2.0/">CC BY-NC</a></p> </i> <div class=article__separator></div> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> If you enjoy this, consider subscribing to my newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <p style="text-align: center">I aim to publish one article a month</p> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="E-mail address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <p>You are looking at Rails 5.2 and its shiny new <a href="https://github.com/rails/rails/tree/master/activestorage">ActiveStorage</a> &ndash; a built-in abstraction/mechanism to handle file storage. You decide to give it a try and remove a dependency you normally use (i.e., <a href="https://github.com/carrierwaveuploader/carrierwave">CarrierWave</a> or <a href="https://github.com/thoughtbot/paperclip">Paperclip</a>).</p> <p>For some reason, you decide to use <a href="https://minio.io/">Minio</a> &ndash; an Amazon S3 compatible open source project.</p> <p>Looking through the ActiveStorage <a href="http://edgeguides.rubyonrails.org/active_storage_overview.html">documentation</a> and <a href="https://github.com/rails/rails/tree/master/activestorage">repository&rsquo;s readme</a>, you figure out how to get everything working locally using ActiveStorage&rsquo;s <code>local</code> service.</p> <p>Now it is time to try running everything, but with Minio as your file storage. Looking at your <code>config/storage.yml</code> you&rsquo;ll see the template for Amazon&rsquo;s S3:</p> <div class=highlight><pre class="highlight yaml"><code> <span class="na">amazon</span><span class="pi">:</span>
   <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
   <span class="na">access_key_id</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:aws, :access_key_id) %&gt;</span>
   <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:aws, :secret_access_key) %&gt;</span>
   <span class="na">region</span><span class="pi">:</span> <span class="s">us-east-1</span>
   <span class="na">bucket</span><span class="pi">:</span> <span class="s">your_own_bucket</span>
</code></pre></div> <h1>Configuration Options</h1> <p>Now it&rsquo;s time to figure out how to use the S3 service in conjunction with your Minio server&hellip;</p> <h2>Region</h2> <p>Your Minio server doesn&rsquo;t really support regions like Amazon&rsquo;s S3. Just keep it as <code>us-east-1</code> or your closest S3 region (although it really could be any string). From what I&rsquo;ve seen, this is just used at the Amazon S3-level, and for your hosted Minio server it does not matter.</p> <p>The <code>region</code> value is simply used to satisfy ActiveStorage and the <code>aws-sdk-s3</code> gem. If you omit the <code>region</code> option you get the following exception <code>missing keyword: region (ArgumentError)</code>. If you use an empty string for <code>region</code> you will see <code>missing region; use :region option or export region name to ENV[&#39;AWS_REGION&#39;] (Aws::Errors::MissingRegionError)</code>.</p> <h2>Endpoint</h2> <p>Your Minio server is hosted at some URL (i.e., https://minio123.com), so you&rsquo;ll need to inform ActiveStorage&rsquo;s S3 service about this <em>endpoint</em>. Luckily, it is just a matter of adding the URL endpoint to your configuration:</p> <div class=highlight><pre class="highlight plaintext"><code>  endpoint: "https://minio123.com" # Points to your Minio server
</code></pre></div> <p>You can also use ports on the endpoint (i.e., &ldquo;http://localhost:9000&rdquo;).</p> <h2>Force Path Style</h2> <p>So you have the endpoint and region all setup from a configuration standpoint. Your Minio server is also up and running, along with a bucket, <code>your_own_bucket</code>. You try to upload a file and see the following exception:</p> <div class=highlight><pre class="highlight plaintext"><code>Aws::Errors::NoSuchEndpointError (Encountered a `SocketError` while attempting to connect to:

  https://you_own_bucket.minio123.com/RJioqjrTT4VmFobw5FhXkSby

This is typically the result of an invalid `:region` option or a
poorly formatted `:endpoint` option.

* Avoid configuring the `:endpoint` option directly. Endpoints are constructed
  from the `:region`. The `:endpoint` option is reserved for connecting to
  non-standard test endpoints.
</code></pre></div> <p>Hmm&hellip; Well that didn&rsquo;t work out. If we look at the URL (https://your_own_bucket.minio123.com), we can see that it uses a bucket subdomain approach. However, Minio expects the bucket after the domain (i.e., https://minio123.com/your_own_bucket). Again, fortunately there is an configuration option we can add to <em>force this path style</em>:</p> <div class=highlight><pre class="highlight plaintext"><code>  force_path_style: true # Needed to be compliant with how Minio serves the bucket
</code></pre></div> <h1>Complete Configuration</h1> <p>At this point we covered all the configuration <em>gotchas</em> to set up ActiveStorage with Minio. Namely, the missing and (mostly undocumented) <code>endpoint</code> and <code>force_path_style</code> options. The following is a complete configuration.</p> <div class=highlight><pre class="highlight yaml"><code> <span class="na">minio</span><span class="pi">:</span>
   <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
   <span class="na">access_key_id</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:minio, :access_key_id) %&gt;</span>
   <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:minio, :secret_access_key) %&gt;</span>
   <span class="na">region</span><span class="pi">:</span> <span class="s">us-east-1</span>
   <span class="na">bucket</span><span class="pi">:</span> <span class="s">your_own_bucket</span>
   <span class="na">endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://minio123.com"</span>
   <span class="na">force_path_style</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div> <p>It isn&rsquo;t a bad idea to have the configuration named <code>minio</code>, just so it is clear that it&rsquo;s a Minio file storage instead of the typical Amazon S3.</p> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="container footer"> <div class="col-md-12 footer__social"> <a href="https://twitter.com/KevinJalbert">Twitter</a> <a href="https://github.com/kevinjalbert">GitHub</a> <a href="https://stackoverflow.com/users/583592/kevin-jalbert">Stack Overflow</a> </div> <div class="col-md-12 footer__copywrite"> Code licensed <a href="https://github.com/kevinjalbert/kevinjalbert.github.io/blob/real-master/LICENSE">MIT</a>, Content &copy; 2019 Kevin Jalbert </div> </div> </html> <script src="/javascripts/app.js"></script>