<!DOCTYPE html> <html lang=en> <head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SZ2C67981H"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SZ2C67981H');
    </script> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=canonical href=https://kevinjalbert.com/respect-http-caching/> <title>Respect HTTP Caching | Kevin Jalbert</title> <meta name=description content="API developers put a lot of time and effort to ensure that their API can scale. One effective way to mitigate load is to use HTTP caching. As developers we need to respect HTTP caching to not waste..."/> <meta name=keywords content="http, caching"/> <meta name=datePublished content="2015-09-24 00:00:00 UTC"/> <meta property="og:article:published_time" content="2015-09-24 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2015-09-24 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/respect-http-caching/"/> <meta property="og:url" content="https://kevinjalbert.com/respect-http-caching/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="API developers put a lot of time and effort to ensure that their API can scale. One effective way to mitigate load is to use HTTP caching. As developers we need to respect HTTP caching to not waste efforts."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/kevin-jalbert.jpg"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="Respect HTTP Caching"/> <meta property="og:description" content="API developers put a lot of time and effort to ensure that their API can scale. One effective way to mitigate load is to use HTTP caching. As developers we need to respect HTTP caching to not waste efforts."/> <meta property="og:image" content="https://kevinjalbert.com/images/kevin-jalbert.jpg"/> <meta property="og:title" content="Respect HTTP Caching"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "Respect HTTP Caching",
       "keywords": "http, caching",
       "url": "https://kevinjalbert.com/respect-http-caching/",
       "datePublished": "2015-09-24 00:00:00 UTC",
       "dateModified": "2015-09-24 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/respect-http-caching/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="/uses/">Uses</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>Respect HTTP Caching</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">September 24, 2015 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>5 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/respect-http-caching/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/caching/">caching</a> <a href="/tags/http/">http</a> </div> </div> </div> <div class=article__separator></div> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> If you enjoy this, consider subscribing to my newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <p style="text-align: center">I aim to publish one article a month</p> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="E-mail address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <p>API developers place plenty of consideration on how to handle scaling. A few techniques and approaches: Application caching, sharding, larger/more servers, background queues, HTTP caching, and Content Delivery Networks (CDNs). A well architected API employs a combination of these solutions to achieve the desired scalability. Of the scaling solutions, very few are actually exposed to the consumers of an API. One strategy in which the end-users actively participate in is <em>HTTP Caching</em>.</p> <p>By respecting HTTP caching on a client&rsquo;s application, network communications complete quicker and in some cases are unnecessary. Network response payloads are sometimes omitted due to a 304 HTTP response. Finally if you use HTTP caching, application servers will love you.</p> <h1>HTTP Caching</h1> <p>If an endpoint is to be hit repeatedly, HTTP caching can dramatically reduce the load on the server. There are a number of ways one can use HTTP caching. Similar to other scaling techniques some of these can be used in tandem.</p> <h2>Cache-Control</h2> <p>On an HTTP response a <code>cache-control</code> header may present. This header provides the client insight on how they should approach making similar requests. For example:</p> <div class=highlight><pre class="highlight plaintext"><code>Cache-Control: max-age=60, must-revalidate
</code></pre></div> <p>The <code>max-age=60</code> specifies that the request should be cached and used locally for a maximum duration of one minute. The <code>must-revalidate</code> forces subsequent requests to still communicate to the server to respect the <em>freshness</em> of the response (i.e., information which indicates that the content of the response has updated). These two simple cache-control headers provide both <em>non-stale</em> responses with reduced payload, provided the endpoint is respecting the max-age (i.e., not changing frequently).</p> <p>To better understand cache-controls, our coworker at theScore, Thuva Tharam, has an <a href="http://techblog.thescore.com/2014/11/19/are-your-cache-control-directives-doing-what-they-are-supposed-to-do/">excellent blog post</a> written on the subject. The individual cache-control directives and their effects are described. Suggestions and examples are provided to illustrate how to use cache-control effectively.</p> <h2>Last-Modified</h2> <p>As previously mentioned, it is possible for a cached request to <code>re-validate</code> with the server to check for <em>freshness</em>. Subsequent requests have an additional <code>If-Modified-Since</code> which contains the value of the response&rsquo;s <code>Last-Modified</code> header. This allows the server to compare the provided time on subsequent requests against the responses and return the full response or simply a <em>304 status code</em>.</p> <p>When a server returns a full response it takes more time to compute/collect the necessary information along with rendering time for the response. With the correct <code>cache-control</code> along with a <code>Last-Modified</code>, a server spends less time constructing the response. A <em>304 status code</em> response is quick, and has a small payload size compared to a normal full response.</p> <h2>ETags</h2> <p>Even when the <code>Last-Modified</code> value has changed, the actual content might still be the same. If the server takes advantage of ETags then there will be an <code>ETag</code> header on the response. The benefit of using ETags shines on requests that do not change often. ETag caching does not expire based on time like the previous two caching mechanisms, and is instead a function of the response&rsquo;s content. This form of caching is ideal as it provides caching while still allowing for freshness of updates to the content.</p> <p>When a subsequent request is made a <code>If-None-Match</code> header is sent along with the previous request&rsquo;s ETag. The server will then use the <em>ETag</em> to determine <em>freshness</em>. If the ETag of the request match the that of the server&rsquo;s response a <em>304 status code</em> is returned.</p> <h1>Respecting HTTP Caching for API Consumers</h1> <blockquote> <p>API Consumers &ndash; Client applications that makes more than one HTTP request to an external web service</p> </blockquote> <p>API Consumers can take on different forms such as a browser or desktop/mobile/web application.</p> <h2>Browsers</h2> <p>Modern browsers have no problem handling HTTP caching. It is also easy to verify that they are respecting HTTP caching by using their <em>Developer Tools</em> interface. The following image shows two requests made to the same API endpoint (https://api.github.com/users/kevinjalbert) in Google Chrome&rsquo;s Network Tab of the Developer Tools:</p> <p>First API request results in a 200 status code (standard success response): <img alt="First Request results in a Status Code 200" width=1366 height=164 src="/images/2015-09-24-respect-http-caching/200-status-code-chrome.png"/></p> <p>Second API request results in a 304 status code (resource has not been modified since the last request, no body is returned in response): <img alt="Second Request results in a Status Code 304" width=1366 height=152 src="/images/2015-09-24-respect-http-caching/304-status-code-chrome.png"/></p> <h2>Mobile Applications</h2> <p>Android and iOS have native mechanisms in place that developers can use to handle HTTP caching on any outbound requests. On iOS there is <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSURLCache_Class/index.html#//apple_ref/occ/cl/NSURLCache">NSURLCache</a> and on Android there is <a href="http://developer.android.com/reference/android/net/http/HttpResponseCache.html">HttpResponseCache</a>. If possible all HTTP requests made from mobile devices should be using the caching mechanisms.</p> <h2>Desktop Applications</h2> <p>Many programming languages can be used when creating desktop applications. In these cases it is best to check whether there is a built HTTP request caching mechanism akin to what Android and iOS have.</p> <h2>Web Applications</h2> <p>It is not uncommon to have web services talking to other web services through a defined API. In these situations there might not be a defined networking layer to push API requests through. For example, within a Ruby/Rails application one might use <a href="https://github.com/lostisland/faraday">Faraday</a> to handle network connections. HTTP caching is not enabled by default on Faraday and is instead an opt-in option.</p> <p>The following is an example of using Faraday with <a href="https://github.com/plataformatec/faraday-http-cache">Faraday::HttpCache</a> middleware to handle HTTP caching.</p> <div class=highlight><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'active_support'</span>
<span class="nb">require</span> <span class="s1">'faraday'</span>
<span class="nb">require</span> <span class="s1">'faraday-http-cache'</span>

<span class="k">module</span> <span class="nn">ApiConsumer</span>
  <span class="k">class</span> <span class="nc">Requester</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">cached: </span><span class="kp">true</span><span class="p">)</span>
      <span class="vi">@connection</span> <span class="o">=</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'https://api.github.com/'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">conn</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">cached</span>
          <span class="n">conn</span><span class="p">.</span><span class="nf">use</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">HttpCache</span><span class="p">,</span>
                   <span class="ss">logger: </span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">),</span>
                   <span class="ss">instrumenter: </span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span>
        <span class="k">end</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">adapter</span> <span class="no">Faraday</span><span class="p">.</span><span class="nf">default_adapter</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="n">start_time</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>

      <span class="n">response</span> <span class="o">=</span> <span class="vi">@connection</span><span class="p">.</span><span class="nf">get</span> <span class="k">do</span> <span class="o">|</span><span class="n">request</span><span class="o">|</span>
        <span class="n">request</span><span class="p">.</span><span class="nf">url</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">time_taken_ms</span> <span class="o">=</span> <span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
      <span class="nb">puts</span> <span class="s2">"Time Taken: </span><span class="si">#{</span><span class="n">time_taken_ms</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> ms"</span>

      <span class="n">response</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Subscribes to all Faraday::HttpCache events</span>
<span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="p">.</span><span class="nf">subscribe</span> <span class="s2">"http_cache.faraday"</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
  <span class="n">event</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"Cache Status: </span><span class="si">#{</span><span class="n">event</span><span class="p">.</span><span class="nf">payload</span><span class="p">[</span><span class="ss">:cache_status</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">"Faraday with HTTP Caching"</span>
<span class="n">api_requester</span> <span class="o">=</span> <span class="no">ApiConsumer</span><span class="o">::</span><span class="no">Requester</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">cached: </span><span class="kp">true</span><span class="p">)</span>
<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">api_requester</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'users/kevinjalbert'</span><span class="p">)</span>
  <span class="nb">sleep</span> <span class="mi">2</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s1">''</span>

<span class="nb">puts</span> <span class="s2">"Faraday without HTTP Caching"</span>
<span class="n">api_requester</span> <span class="o">=</span> <span class="no">ApiConsumer</span><span class="o">::</span><span class="no">Requester</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">cached: </span><span class="kp">false</span><span class="p">)</span>
<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">api_requester</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'users/kevinjalbert'</span><span class="p">)</span>
  <span class="nb">sleep</span> <span class="mi">2</span>
<span class="k">end</span>
</code></pre></div> <p>Executing the above example produces the following log statements. With caching the time taken per request decreases tremendously on subsequent requests. By respecting the HTTP cache-controls of the API, the subsequent request can be used until the cache-control directives say otherwise (i.e., ETag/Last-Modified changes, or the cache expires exceeding the max-age).</p> <div class=highlight><pre class="highlight plaintext"><code>Faraday with HTTP Caching
D, [2015-09-20T23:06:27.570751 #15189] DEBUG -- : HTTP Cache: [GET /users/kevinjalbert] miss, store
Cache Status: miss
Time Taken: 1396.139 ms
D, [2015-09-20T23:06:29.577798 #15189] DEBUG -- : HTTP Cache: [GET /users/kevinjalbert] fresh
Cache Status: fresh
Time Taken: 1.857 ms
D, [2015-09-20T23:06:31.580719 #15189] DEBUG -- : HTTP Cache: [GET /users/kevinjalbert] fresh
Cache Status: fresh
Time Taken: 0.971 ms
D, [2015-09-20T23:06:33.585455 #15189] DEBUG -- : HTTP Cache: [GET /users/kevinjalbert] fresh
Cache Status: fresh
Time Taken: 1.139 ms
D, [2015-09-20T23:06:35.587833 #15189] DEBUG -- : HTTP Cache: [GET /users/kevinjalbert] fresh
Cache Status: fresh
Time Taken: 1.133 ms

Faraday without HTTP Caching
Time Taken: 807.486 ms
Time Taken: 277.589 ms
Time Taken: 186.115 ms
Time Taken: 475.249 ms
Time Taken: 1130.691 ms
</code></pre></div> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="container footer"> <div class="col-md-12 footer__social"> <a href="https://twitter.com/KevinJalbert">Twitter</a> <a href="https://github.com/kevinjalbert">GitHub</a> <a href="https://stackoverflow.com/users/583592/kevin-jalbert">Stack Overflow</a> </div> <div class="col-md-12 footer__copywrite"> Code licensed <a href="https://github.com/kevinjalbert/kevinjalbert.github.io/blob/real-master/LICENSE">MIT</a>, Content &copy; 2019 Kevin Jalbert </div> </div> </html> <script src="/javascripts/app.js"></script>