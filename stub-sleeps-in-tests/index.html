<!DOCTYPE html> <html lang=en> <head> <script async src="https://www.googletagmanager.com/gtag/js?id=G-SZ2C67981H"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SZ2C67981H');
    </script> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=canonical href=https://kevinjalbert.com/stub-sleeps-in-tests/> <title>Stub Sleeps in Tests | Kevin Jalbert</title> <meta name=description content="A quick tip - when working with a code base that has sleep/delays in it, where you want to stub them out."/> <meta name=keywords content="testing, ruby"/> <meta name=datePublished content="2021-08-29 00:00:00 UTC"/> <meta property="og:article:published_time" content="2021-08-29 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2021-08-29 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/stub-sleeps-in-tests/"/> <meta property="og:url" content="https://kevinjalbert.com/stub-sleeps-in-tests/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="A quick tip - when working with a code base that has sleep/delays in it, where you want to stub them out."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/2021-08-29-stub-sleeps-in-tests/hammer-clock.jpg"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="Stub Sleeps in Tests"/> <meta property="og:description" content="A quick tip - when working with a code base that has sleep/delays in it, where you want to stub them out."/> <meta property="og:image" content="https://kevinjalbert.com/images/2021-08-29-stub-sleeps-in-tests/hammer-clock.jpg"/> <meta property="og:title" content="Stub Sleeps in Tests"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "Stub Sleeps in Tests",
       "keywords": "testing, ruby",
       "url": "https://kevinjalbert.com/stub-sleeps-in-tests/",
       "datePublished": "2021-08-29 00:00:00 UTC",
       "dateModified": "2021-08-29 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/stub-sleeps-in-tests/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="/uses/">Uses</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>Stub Sleeps in Tests</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">August 29, 2021 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>1 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/stub-sleeps-in-tests/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/ruby/">ruby</a> <a href="/tags/testing/">testing</a> </div> </div> </div> <img src=/images/2021-08-29-stub-sleeps-in-tests/hammer-clock.jpg> <i><p><a href="https://flickr.com/photos/91261194@N06/45404836131" title="Book,Clock and Hammer">Book,Clock and Hammer</a> by <a href="https://flickr.com/people/91261194@N06">focusonmore.com</a> is licensed under <a href="https://creativecommons.org/licenses/by/2.0/">CC BY</a></p> </i> <div class=article__separator></div> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> If you enjoy this, consider subscribing to my newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <p style="text-align: center">I aim to publish one article a month</p> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="E-mail address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <p>I&rsquo;m doing another short post here on testing code. I&rsquo;ve observed that sometimes sleeps/delays find their way into production. A quick example of this would be for a retry loop (e.g., HTTP requests). When testing the code concerning these areas, you are taking on the duration of the sleep in your test suite which is slow and undesirable.</p> <p>To combat the added delay in sleeps during tests, my recommendation is to stub/mock out the sleep method. Depending on the language, there are many ways to handle this. With Ruby using <a href="https://github.com/seattlerb/minitest">Minitest</a> and <a href="https://github.com/freerange/mocha">Mocha</a>, you would do the following:</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># Class that sleeps for five 1 second iterations, building an array of [0..4]</span>
<span class="k">class</span> <span class="nc">SleepyObject</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">do_work</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">index</span><span class="o">|</span>
      <span class="n">results</span> <span class="o">&lt;&lt;</span> <span class="n">index</span>
      <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">results</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Minitest and Mocha are needed for testing/stubbing</span>
<span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require</span> <span class="s1">'mocha'</span>
<span class="nb">require</span> <span class="s1">'mocha/minitest'</span>

<span class="c1"># Test class</span>
<span class="k">class</span> <span class="nc">SleepyObjectTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>

  <span class="c1"># Takes 5 seconds to run</span>
  <span class="k">def</span> <span class="nf">test_with_sleeps</span>
    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">,</span> <span class="no">SleepyObject</span><span class="p">.</span><span class="nf">do_work</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Takes pretty much 0 seconds to run</span>
  <span class="c1"># We are also asserting that five calls to `sleep` do happen</span>
  <span class="k">def</span> <span class="nf">test_without_sleeps</span>
    <span class="no">SleepyObject</span><span class="p">.</span><span class="nf">expects</span><span class="p">(</span><span class="ss">:sleep</span><span class="p">).</span><span class="nf">times</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="p">,</span> <span class="no">SleepyObject</span><span class="p">.</span><span class="nf">do_work</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>When we run the above code, we see the following:</p> <div class=highlight><pre class="highlight plaintext"><code>Run options: -v --seed 14433

# Running:

SleepyObjectTest#test_with_sleeps = 5.02 s = .
SleepyObjectTest#test_without_sleeps = 0.00 s = .

Finished in 5.018095s, 0.3986 runs/s, 0.5978 assertions/s.

2 runs, 3 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div> <p>The tests using stubs execute quickly, and we still retain the ability to <em>assert</em> that <em>sleeps</em> are happening. This is a <em>win-win</em> in my books.</p> <p>It can be a bit difficult to <em>figure out</em> what tests in your test suite that is affected by sleep durations. As the test creator, you&rsquo;ll likely have a good idea of any sleep/delays in your test execution as you run them in isolation during development. I did find the following <a href="https://dev.to/joeyschoblaska/make-your-specs-faster-with-sleep-study-1ff">article</a> that presents a novel approach to identify which tests have sleeps in their execution path.</p> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="container footer"> <div class="col-md-12 footer__social"> <a href="https://twitter.com/KevinJalbert">Twitter</a> <a href="https://github.com/kevinjalbert">GitHub</a> <a href="https://stackoverflow.com/users/583592/kevin-jalbert">Stack Overflow</a> </div> <div class="col-md-12 footer__copywrite"> Code licensed <a href="https://github.com/kevinjalbert/kevinjalbert.github.io/blob/real-master/LICENSE">MIT</a>, Content &copy; 2019 Kevin Jalbert </div> </div> </html> <script src="/javascripts/app.js"></script>