<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <script>addEventListener('error', window.__e=function f(e){f.q=f.q||[];f.q.push(e)});</script> <link rel=canonical href=https://kevinjalbert.com/testing-the-use-of-rails-caching/> <title>Testing the Use of Rails Caching | Kevin Jalbert</title> <meta name=description content="There is a strong test culture for Rubyist using Rails. Caching can be rewarding in performance, yet can introduce cache complexities. Read about how I approach testing low-level caching."/> <meta name=keywords content="rails, testing"/> <meta name=datePublished content="2020-01-30 00:00:00 UTC"/> <meta property="og:article:published_time" content="2020-01-30 00:00:00 UTC"/> <meta name=author content="Kevin Jalbert"/> <meta property="og:article:author" content="2020-01-30 00:00:00 UTC"/> <meta name=url content="https://kevinjalbert.com/testing-the-use-of-rails-caching/"/> <meta property="og:url" content="https://kevinjalbert.com/testing-the-use-of-rails-caching/"/> <meta name=site content="Kevin Jalbert"/> <meta property="og:site_name" content="Kevin Jalbert"/> <meta name="twitter:card" content=summary_large_image /> <meta name="twitter:creator" content="@kevinjalbert"/> <meta name="twitter:description" content="There is a strong test culture for Rubyist using Rails. Caching can be rewarding in performance, yet can introduce cache complexities. Read about how I approach testing low-level caching."/> <meta name="twitter:image:src" content="https://kevinjalbert.com/images/2020-01-30-testing-the-use-of-rails-caching/post-office-boxes.jpg"/> <meta name="twitter:site" content="Kevin Jalbert"/> <meta name="twitter:title" content="Testing the Use of Rails Caching"/> <meta property="og:description" content="There is a strong test culture for Rubyist using Rails. Caching can be rewarding in performance, yet can introduce cache complexities. Read about how I approach testing low-level caching."/> <meta property="og:image" content="https://kevinjalbert.com/images/2020-01-30-testing-the-use-of-rails-caching/post-office-boxes.jpg"/> <meta property="og:title" content="Testing the Use of Rails Caching"/> <script type="application/ld+json">
    {
       "@context": "http://schema.org",
       "@type": "BlogPosting",
       "headline": "Testing the Use of Rails Caching",
       "keywords": "rails, testing",
       "url": "https://kevinjalbert.com/testing-the-use-of-rails-caching/",
       "datePublished": "2020-01-30 00:00:00 UTC",
       "dateModified": "2020-01-30 00:00:00 UTC",
       "author": {
         "@type": "Person",
         "name": "Kevin Jalbert",
         "sameAs": [
           "https://twitter.com/kevinjalbert",
           "https://github.com/kevinjalbert",
           "https://keybase.io/kevinjalbert",
           "https://reddit.com/user/kevinjalbert"
         ]
       },
       "mainEntityOfPage": {
          "@type": "WebPage",
         "@id": "https://kevinjalbert.com/testing-the-use-of-rails-caching/"
       }
    }
  </script> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Articles | Kevin Jalbert" href="/feed.xml"/> <script async src="/vendor/analytics/index.js"></script> <script async src="https://www.google-analytics.com/analytics.js"></script> </head> <div class=container> <div class=header> <div class="col-xs-12 col-sm-7 navigation"> <a class=banner href="/">Kevin Jalbert</a> <a href="/about/">About</a> <a href="/now/">Now</a> <a href="/uses/">Uses</a> <a href="https://github.com/kevinjalbert/ama/blob/master/README.md">AMA</a> </div> <div class="col-xs-12 col-sm-5 search-component"> <input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>Testing the Use of Rails Caching</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class="article__date entry-date">January 30, 2020 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>2 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/testing-the-use-of-rails-caching/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/rails/">rails</a> <a href="/tags/testing/">testing</a> </div> </div> </div> <img src=/images/2020-01-30-testing-the-use-of-rails-caching/post-office-boxes.jpg> <i><p><a href="https://flickr.com/photos/vpickering/4134811904" title="59/365 - 11/25/09">59/365 - 11/25/09</a> by <a href="https://flickr.com/people/vpickering">vpickering</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/2.0/">CC BY-NC-ND</a></p> </i> <div class=article__separator></div> <p>I was doing some performance work within a Rails application where expensive (computationally) data was being generated on each request. It was quick to implement the low-level caching that wrapped the expensive data generation. In this particular case, I wanted to ensure that the caching logic was valid as there were numerous conditions at play. I normally wouldn&rsquo;t test caching if the cache key was something trivial (or automatic like using <code>ActiveRecord#cache_key</code>).</p> <blockquote> <p>There are only two hard things in Computer Science: cache invalidation and naming things.</p> <p>&ndash; Phil Karlton (<a href="https://martinfowler.com/bliki/TwoHardThings.html">source</a>)</p> </blockquote> <h1>Peering into the Cache</h1> <p>This Rails application had the <code>cache_store</code> set to <code>:memory_store</code> in the test environment. We wanted to make sure that our tests were still going through the same code paths as would happen in production.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># config/environments/test.rb:</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:memory_store</span>
<span class="k">end</span>
</code></pre></div> <p>The inner data structure of <code>ActiveSupport::Cache::MemoryStore</code> is not publically accessible.</p> <div class=highlight><pre class="highlight plaintext"><code>[1] pry(main)&gt; Rails.cache.write('my-cache-key', 'my-value')
=&gt; true
[2] pry(main)&gt; Rails.cache
=&gt; &lt;#ActiveSupport::Cache::MemoryStore entries=1, size=260, options={}&gt;
[3] pry(main)&gt; ls Rails.cache
ActiveSupport::ToJsonWithActiveSupportEncoder#methods: to_json
ActiveSupport::Dependencies::ZeitwerkIntegration::RequireDependency#methods: require_dependency
ActiveSupport::Cache::Store#methods: delete  exist?  fetch  fetch_multi  logger  logger=  mute  options  read  read_multi  silence  silence!  silence?  write  write_multi
ActiveSupport::Cache::MemoryStore#methods: cleanup  clear  decrement  delete_matched  increment  inspect  prune  pruning?  synchronize
instance variables: @cache_size  @data  @key_access  @max_prune_time  @max_size  @monitor  @options  @pruning
class variables: @@logger
</code></pre></div> <p>The <em>raw</em> data is held in the instance variable <code>@data</code>. We can <em>reach in</em> and grab that to perform some inspections:</p> <div class=highlight><pre class="highlight plaintext"><code>[4] pry(main)&gt; Rails.cache.instance_variable_get(:@data)
=&gt; {"my-cache-key"=&gt;#&lt;ActiveSupport::Cache::Entry:0x00007f8ade4da858 @created_at=1580064434.3177679, @expires_in=nil, @value="my-value", @version=nil&gt;}
</code></pre></div> <p>The caveat of this approach is clear, as we&rsquo;re reaching into the private space of the Rails cache.</p> <h1>Creating the Helper</h1> <p>I wanted to make it easier for myself and others to test Rails caching in this project. Creating a test helper is ideal as all the tests can reach for the built utilities when testing code related to caching.</p> <p>We&rsquo;ll create a new test helper, that can be included in our <code>test/test_helper.rb</code>:</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># test/support/rails_cache_helper.rb:</span>
<span class="k">module</span> <span class="nn">RailsCacheHelper</span>
  <span class="k">def</span> <span class="nf">with_clean_caching</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">clear</span>
    <span class="k">yield</span>

  <span class="k">ensure</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">clear</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">cache_has_value?</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">cache_data</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:value</span><span class="p">).</span><span class="nf">any?</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">key_for_cached_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">cache_data</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="o">|</span>
      <span class="k">return</span> <span class="n">key</span> <span class="k">if</span> <span class="n">entry</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">value</span> <span class="o">==</span> <span class="n">value</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">cache_data</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">instance_variable_get</span><span class="p">(</span><span class="ss">:@data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>This helper gives us three utilities:</p> <ol> <li>The <code>with_clean_caching</code> method, which purges the cache before and after the <em>block</em> is executed. It is worth noting that the <code>:memory_store</code> is only purged at the end of the test suite.</li> <li>The <code>cache_has_value?(value)</code> method, which returns a <em>boolean</em> if the cache has the specified <em>value</em>.</li> <li>The <code>key_for_cached_value(value)</code> method, which returns the <em>key</em> that can be used to look up the specified <em>value</em>.</li> </ol> <p>With these new methods, it was much easier to test the caching code. There was no need to do any fancy stubbing and/or using mock objects.</p> <p>Note: there are more features that can be expanded upon in this helper:</p> <ul> <li>Working with the meta-data on cache entries (e.g., <code>expires_in</code>).</li> <li>Custom assertions (e.g., <code>assert_cached(value)</code>).</li> </ul> <h1>Testing Rails Caching</h1> <p>Now I was able to test the caching specifically. I wrapped my tests in <code>with_clean_caching</code> as these tests were specific about using caching. I could have also approached this by making it so the cache is purged before each test (e.g., <code>setup()</code>, <code>before(:each)</code>), but I didn&rsquo;t opt for that right now.</p> <p>The following is a contrived example, but you could imagine that the <em>cache key</em> is generated much deeper in the application code. This makes it difficult to <em>get</em> the cache key to then inspect and make assertions about the cached data.</p> <p>Using <code>RailsCacheHelper</code> (that we created above), we can make use of <code>#cache_has_value?</code> and <code>#key_for_cached_value</code> to make assertions based on the returned value without needing to know the <em>cache key</em>.</p> <div class=highlight><pre class="highlight ruby"><code><span class="c1"># test/caching_test.rb</span>
<span class="k">class</span> <span class="nc">CachingTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s1">'caching works'</span> <span class="k">do</span>
    <span class="n">with_clean_caching</span> <span class="k">do</span>
      <span class="c1"># bunch of test setup ...</span>

      <span class="n">result</span> <span class="o">=</span> <span class="no">Caching</span><span class="p">.</span><span class="nf">expensive_call</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="n">data_structure</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>

      <span class="n">assert</span><span class="p">(</span><span class="n">cache_has_value?</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'caching is not used if request header specifies caching=false'</span> <span class="k">do</span>
    <span class="n">with_clean_caching</span> <span class="k">do</span>
      <span class="c1"># bunch of test setup, and adding caching=false in request_data ...</span>

      <span class="n">result</span> <span class="o">=</span> <span class="no">Caching</span><span class="p">.</span><span class="nf">expensive_call</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="n">data_structure</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>

      <span class="n">assert</span><span class="p">(</span><span class="n">cache_has_value?</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'cache varies correctly based on object'</span> <span class="k">do</span>
    <span class="n">with_clean_caching</span> <span class="k">do</span>
      <span class="c1"># bunch of test setup ...</span>

      <span class="n">original_result</span> <span class="o">=</span> <span class="no">Caching</span><span class="p">.</span><span class="nf">expensive_call</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="n">data_structure</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>
      <span class="n">original_key</span> <span class="o">=</span> <span class="n">key_for_cached_value</span><span class="p">(</span><span class="n">original_result</span><span class="p">)</span>

      <span class="c1"># setup different_object</span>

      <span class="n">changed_object_result</span> <span class="o">=</span> <span class="no">Caching</span><span class="p">.</span><span class="nf">expensive_call</span><span class="p">(</span><span class="n">different_object</span><span class="p">,</span> <span class="n">data_structure</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>
      <span class="n">changed_object_key</span> <span class="o">=</span> <span class="n">key_for_cached_value</span><span class="p">(</span><span class="n">changed_object_result</span><span class="p">)</span>

      <span class="n">rufute_equal</span><span class="p">(</span><span class="n">original_key</span><span class="p">,</span> <span class="n">changed_object_key</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'cache varies correctly based on data structure'</span> <span class="k">do</span>
    <span class="n">with_clean_caching</span> <span class="k">do</span>
      <span class="c1"># pretty much same as the last test but varying the data structure</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'cache varies correctly based on request data'</span> <span class="k">do</span>
    <span class="n">with_clean_caching</span> <span class="k">do</span>
      <span class="c1"># pretty much same as the last test but varying the request_data</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Note that this approach worked for me, however, there are many different ways to test Rails caching. For example, this <a href="https://stackoverflow.com/a/9603083/583592">StackOverflow answer</a> suggests making an <code>InspectableMemoryStore</code> which subclasses <code>ActiveSupport::Cache::MemoryStore</code>.</p> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> Signup for my Newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="email address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <div class=article__comments-button><button type=button class="btn btn-default show-comments">Click to Disqus</button></div> <div id=disqus_thread></div> </div> </div> </div> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </body> <div class="container footer"> <div class="col-md-12 footer__social"> <a href="https://twitter.com/KevinJalbert">Twitter</a> <a href="https://github.com/kevinjalbert">GitHub</a> <a href="https://stackoverflow.com/users/583592/kevin-jalbert">Stack Overflow</a> </div> <div class="col-md-12 footer__copywrite"> Code licensed <a href="https://github.com/kevinjalbert/kevinjalbert.github.io/blob/real-master/LICENSE">MIT</a>, Content &copy; 2019 Kevin Jalbert </div> </div> </html> <script src="/javascripts/app.js"></script>